<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Register | HeartWise</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="dashboard.css" rel="stylesheet" />
</head>

<body>
    <div class="container">
        <header>
            <h1>HeartWise</h1>
            <nav>
                <h3 class="welcomediv">Welcome Back</h3>
            </nav>
        </header>

        <main>
            <section class="heart-rate-monitor">
                <main style="display: flex; gap: 2rem; flex-wrap: wrap;">
                    <section class="heart-rate-monitor">
                        <h2>Heart Rate Overview</h2>
                        <div class="heart-rate-display">
                            <div class="current-rate">
                                <span class="heart-rate-value">N/A</span>
                            </div>
                            <div class="rate-status">
                                <span class="status-icon">ðŸ’“</span>
                                <span class="status-text">Normal</span>
                            </div>
                        </div>
                        <div class="rate-history">
                            <div class="history-item">
                                <span>Morning</span>
                                <span id="morning-readings">N/A</span>
                            </div>
                            <div class="history-item">
                                <span>Afternoon</span>
                                <span id="afternoon-readings">N/A</span>
                            </div>
                            <div class="history-item">
                                <span>Evening</span>
                                <span id="evening-readings">N/A</span>
                            </div>
                        </div>
                    </section>
                
                    <!-- SpO2 Overview Section -->
                    <section class="spo2-monitor">
                        <h2>Oxygen Saturation (SpOâ‚‚)</h2>
                        <div class="spo2-display">
                            <div class="spo2-value" style="font-size: 2rem;">N/A</div>
                            <div class="spo2-status" style="font-size: 1.1rem; margin-top: 0.5rem;">Loading...</div>
                        </div>
                    </section>
                </main>
                
            </section>

            <section class="ai-insights">
                <h2>Health Insights</h2>
                <div class="insights-grid">
                  <div class="insight-box heart-rate-insight">
                    <h3>Heart Rate Insights</h3>
                    <div class="heart-rate-insight-content">
                      <p id="heart-rate-text">Loading...</p>
                      <ul id="heart-rate-recommendations"></ul>
                    </div>
                  </div>
              
                  <div class="insight-box spo2-insight">
                    <h3>SpOâ‚‚ Insights</h3>
                    <div class="spo2-insight-content">
                      <p id="spo2-text">Loading...</p>
                      <p id="stress-level-text"></p>
                      <ul id="spo2-recommendations"></ul>
                    </div>
                  </div>
                </div>
              </section>
              
        </main>

        <footer>
            <p>&copy; 2025 HeartWise. All rights reserved.</p>
        </footer>
    </div>
    <script>
document.addEventListener("DOMContentLoaded", () => {
  const username = localStorage.getItem("username");
  const welcomeDiv = document.querySelector(".welcomediv");

  welcomeDiv.textContent = username
    ? `Welcome Back, ${username}`
    : "Welcome Back!";

  fetchHeartRate();
  fetchHealthInsights();
  loadHeartRateByPeriod();

  // Refresh data every 5s
  setInterval(fetchHeartRate, 5000);
  setInterval(fetchHealthInsights, 5000);
});

async function fetchHeartRate() {
  const username = localStorage.getItem("username");
  if (!username) return;

  try {
    const response = await fetch("https://health-monitoring-system-7l2y.onrender.com/health_data", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ username }),
    });

    const data = await response.json();

    if (data.success) {
      const heartRate = data.heart_rate;
      document.querySelector(".heart-rate-value").textContent = `${heartRate} BPM`;

      const statusText = document.querySelector(".status-text");
      if (heartRate >= 60 && heartRate <= 100) {
        statusText.textContent = "Normal";
        statusText.style.color = "green";
      } else if (heartRate < 60) {
        statusText.textContent = "Low";
        statusText.style.color = "orange";
      } else {
        statusText.textContent = "High";
        statusText.style.color = "red";
      }
    } else {
      showHeartRateError("Unavailable");
    }
  } catch (error) {
    console.error("Error fetching heart rate:", error);
    showHeartRateError("Error");
  }
}

function showHeartRateError(message) {
  document.querySelector(".heart-rate-value").textContent = "N/A";
  const statusText = document.querySelector(".status-text");
  statusText.textContent = message;
  statusText.style.color = "gray";
}

async function loadHeartRateByPeriod() {
  try {
    const response = await fetch("https://health-monitoring-system-7l2y.onrender.com/health_data/periodic");
    const result = await response.json();

    if (!result.success) {
      console.error("Error:", result.message);
      return;
    }

    const { Morning, Afternoon, Evening } = result.data;

    document.getElementById("morning-readings").innerHTML =
      Morning.map(r => `<div>${r.heart_rate} BPM</div>`).join("");
    document.getElementById("afternoon-readings").innerHTML =
      Afternoon.map(r => `<div>${r.heart_rate} BPM</div>`).join("");
    document.getElementById("evening-readings").innerHTML =
      Evening.map(r => `<div>${r.heart_rate} BPM</div>`).join("");
  } catch (err) {
    console.error("Fetch error:", err);
  }
}

async function fetchHealthInsights() {
  const username = localStorage.getItem("username");
  if (!username) return;

  try {
    const [heartRateResponse, spo2Response] = await Promise.all([
      fetch("https://health-monitoring-system-7l2y.onrender.com/health_data/insights", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username }),
      }),
      fetch("https://health-monitoring-system-7l2y.onrender.com/health_data/spo2", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username }),
      }),
    ]);

    const heartRateData = await heartRateResponse.json();
    const spo2Data = await spo2Response.json();

    if (heartRateData.success && spo2Data.success) {
      const heartRate = heartRateData.heart_rate;
      const insights = heartRateData.insights;
      const spo2 = spo2Data.estimated_spo2;

      document.querySelector(".spo2-value").textContent = spo2 + "%";
      const spo2Status = document.querySelector(".spo2-status");

      if (spo2 >= 95) {
        spo2Status.textContent = "Normal";
        spo2Status.style.color = "green";
      } else if (spo2 >= 90) {
        spo2Status.textContent = "Low";
        spo2Status.style.color = "orange";
      } else {
        spo2Status.textContent = "Critical";
        spo2Status.style.color = "red";
      }

      let stress = "Normal";
      if (spo2 >= 95) stress = "Low";
      else if (spo2 >= 90) stress = "Moderate";
      else stress = "High";

      document.getElementById("heart-rate-text").textContent = `Heart Rate: ${heartRate} BPM`;
      document.getElementById("spo2-text").textContent = `SpOâ‚‚: ${spo2}%`;
      document.getElementById("stress-level-text").innerHTML = `Stress Level: <strong>${stress}</strong>`;

      document.getElementById("heart-rate-recommendations").innerHTML = `<li>${insights}</li>`;

      const spo2List = document.getElementById("spo2-recommendations");
      if (spo2 >= 95) {
        spo2List.innerHTML = `<li>Your oxygen levels are good. Keep it up!</li>`;
      } else if (spo2 >= 90) {
        spo2List.innerHTML = `
          <li>Your oxygen levels are slightly low. Try deep breathing.</li>
          <li>Check ventilation in your room.</li>`;
      } else {
        spo2List.innerHTML = `
          <li>Oxygen is very low. Practice deep breathing immediately.</li>
          <li>Seek medical advice if this persists.</li>
          <li>Move to fresh air.</li>`;
      }
    } else {
      console.error("Error:", heartRateData.message || spo2Data.message);
    }
  } catch (err) {
    console.error("Fetch error:", err);
  }
}
</script>


    <script src="https://cdn.gpteng.co/gptengineer.js" type="module"></script>
</body>

</html>
